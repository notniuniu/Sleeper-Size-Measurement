# 双块式轨枕点云检测系统

## 作者
铁道建筑研究所 安全检测事业部 牛浩然
2025年10月

## 项目概述
本项目是一个基于点云处理技术的双块式轨枕几何参数自动检测系统。系统能够批量处理来自两个相机的点云数据，实现轨枕的三维重建、分割、去噪以及多种几何参数的精确测量，为轨枕生产质量控制提供高效、准确的检测手段。

## 系统功能

### 1. 点云数据处理
- 支持多种格式点云数据加载（TXT、PLY）
- 自适应下采样和离群点过滤
- 点云自动对齐和旋转，确保测量一致性
- 左下角噪声区域识别与去除
- 主成分分析（PCA）点云对齐，使长轴与X轴平行

### 2. 轨枕参数测量
- **轨枕几何尺寸测量**：包括长度、宽度等基础参数
- **承轨台倾斜角测量**：通过点云表面拟合计算倾斜角度
- **单元块参数测量**：使用分层切片法测量上宽W0、下宽W1、上长L0和下长L1等参数
- **距离聚类和直线拟合**：用于精确计算轨枕关键部位尺寸

### 3. 批量处理功能
- 自动识别D:\images目录下的点云文件
- 按UUID分组处理两个相机的数据
- 处理完成后自动删除已处理的文件，避免重复处理
- 提供详细的处理日志和错误处理机制

## 项目结构

```

├── PCA_Pose_Calibration.py    # 点云姿态校准模块
├── mes_script.py              # 主脚本，用于批量处理点云文件
├── measurement_main.py        # 测量主类，集成各个测量模块
├── point_preprocess.py        # 点云预处理模块
├── point_segmentation.py      # 点云分割模块
├── point_bottom_left_denoising.py  # 左下角噪声去除模块
├── measurement_1.py           # 轨枕基础参数测量
├── measurement_2.py           # 承轨台倾斜角测量
├── measurement_3.py           # 单元块参数测量
├── parallelogram_measurement.py  # 平行四边形测量模块
├── txt2ply.py                 # TXT文件转PLY文件工具
├── requirements.txt           # 项目依赖库列表
├── __pycache__/               # Python编译缓存目录
├── data/                      # 测试数据目录
├── logs/                      # 日志文件目录
├── results/                   # 结果输出目录
└── test_results/              # 测试结果目录
```

## 安装与配置

### 环境要求
- Python 3.8+
- CUDA支持（可选，用于加速点云处理）

### 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖库：
- open3d==0.18.0: 点云处理核心库
- numpy==1.24.4: 数值计算
- scipy==1.11.1: 科学计算
- scikit-learn==1.3.0: 机器学习算法
- opencv-python==4.8.0.76: 图像处理
- matplotlib==3.7.2: 可视化
- tqdm==4.66.4: 进度显示

## 使用说明

### 1. 准备数据
将采集的点云数据文件（TXT格式）放入`D:\images`目录。文件命名格式应为：
```
pointData-{camera_id}-{uuid}.txt
```
其中，`camera_id`为相机编号（0或1），`uuid`为每组数据的唯一标识。

### 2. 运行批量处理

```bash
python mes_script.py
```

程序将自动：
- 扫描`D:\images`目录下的所有点云文件
- 按UUID分组，每组包含两个相机的数据
- 处理每组数据，包括点云预处理、测量和结果保存
- 处理成功后删除已处理的文件

### 3. 查看结果

处理结果将保存在`results/{uuid}`目录下，包括：
- 中间处理结果（下采样点云、聚类去噪点云等）
- 测量结果JSON文件
- 可视化结果（PLY格式点云文件）

## 核心算法说明

### 1. 点云预处理
系统采用自适应体素下采样算法，根据点云规模自动调整体素大小，确保保留足够的点云细节。同时使用统计离群点去除算法过滤噪声点。

### 2. 点云对齐
使用主成分分析（PCA）计算点云的主方向，并通过旋转变换使点云的长轴与X轴完全平行，为后续的精确测量奠定基础。

### 3. 噪声去除
专门针对边界盒左下角区域实现了基于DBSCAN聚类的噪声去除算法，能够有效地识别和过滤该区域的噪声点。

### 4. 参数测量
- **分层切片法**：用于测量单元块的几何参数
- **平面拟合**：计算承轨台的倾斜角度
- **距离聚类与直线拟合**：用于精确计算轨枕的宽度和长度

## 配置与调优

### 参数调整
各模块中的核心参数可以根据实际数据特点进行调整，主要包括：
- 下采样体素大小
- 聚类算法参数（eps、min_points）
- 切片比例和数量
- 噪声去除阈值

### 日志级别设置
可通过修改各模块中的logging配置调整日志输出级别：

```python
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
```

## 注意事项

1. 确保输入的点云数据质量良好，避免过多的噪声点
2. 两个相机的数据需要配对正确，确保UUID一致
3. 处理大量数据时，确保系统有足够的内存资源
4. 结果文件将根据UUID组织，便于查找和管理

## 故障排除

### 常见问题及解决方案

1. **文件读取失败**
   - 检查文件格式是否正确
   - 确认文件编码（程序支持UTF-8和GBK）

2. **测量结果不准确**
   - 调整下采样和去噪参数
   - 检查点云对齐是否正确

3. **内存不足**
   - 增加体素下采样的大小
   - 减少同时处理的点云数量

## 后续改进方向

1. 优化算法性能，提高处理速度
2. 增强系统的鲁棒性，适应更多种类的点云数据
3. 开发可视化界面，提高操作便捷性
4. 添加自动报告生成功能

## 许可证

本项目仅供铁道建筑研究所内部使用，未经授权不得外传。